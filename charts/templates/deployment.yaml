apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "validation-gcp.fullname" . }}
  labels:
    {{- include "validation-gcp.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      {{- include "validation-gcp.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmap-app.yaml") . | sha256sum }}
        checksum/broker-config: {{ include (print $.Template.BasePath "/configmap-broker.yaml") . | sha256sum }}
      labels:
        {{- include "validation-gcp.selectorLabels" . | nindent 8 }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "validation-gcp.serviceAccountName" . }}
      securityContext:
        fsGroup: 65532
        runAsNonRoot: true
        runAsUser: 65532
      containers:
        - name: {{ .Chart.Name }}
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
            seccompProfile:
              type: RuntimeDefault
          image: "{{ .Values.image.registry }}/{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command:
            - /app/adapter
          args:
            - serve
          env:
            - name: LOG_LEVEL
              value: {{ .Values.logging.level | default "info" | quote }}
            - name: LOG_FORMAT
              value: {{ .Values.logging.format | default "text" | quote }}
            - name: LOG_OUTPUT
              value: {{ .Values.logging.output | default "stderr" | quote }}
            {{- with .Values.env }}
            {{- range . }}
            - name: {{ .name }}
              {{- if .value }}
              value: {{ .value | quote }}
              {{- else if .valueFrom }}
              valueFrom:
                {{- toYaml .valueFrom | nindent 16 }}
              {{- end }}
            {{- end }}
            {{- end }}
            {{- if .Values.hyperfleetApi.baseUrl }}
            - name: HYPERFLEET_API_BASE_URL
              value: {{ .Values.hyperfleetApi.baseUrl | quote }}
            {{- end }}
            - name: HYPERFLEET_API_VERSION
              value: {{ .Values.hyperfleetApi.version | default "v1" | quote }}
            - name: ADAPTER_CONFIG_PATH
              value: /etc/adapter/adapter.yaml
            {{- if .Values.broker.type }}
            - name: BROKER_CONFIG_FILE
              value: /etc/broker/broker.yaml
            {{- if eq .Values.broker.type "googlepubsub" }}
            - name: BROKER_SUBSCRIPTION_ID
              value: {{ .Values.broker.googlepubsub.subscription | quote }}
            - name: BROKER_TOPIC
              value: {{ .Values.broker.googlepubsub.topic | quote }}
            - name: GCP_PROJECT_ID
              value: {{ .Values.broker.googlepubsub.projectId | quote }}
            {{- end }}
            {{- end }}
            # Common validation environment variables
            - name: STATUS_REPORTER_IMAGE
              value: {{ .Values.validation.statusReporterImage | quote }}
            - name: RESULTS_PATH
              value: {{ .Values.validation.resultsPath | quote }}
            - name: MAX_WAIT_TIME_SECONDS
              value: {{ .Values.validation.maxWaitTimeSeconds | quote }}
            {{- if .Values.validation.useDummy }}
            # Dummy validation specific environment variables
            - name: SIMULATE_RESULT
              value: {{ .Values.validation.dummy.simulateResult | quote }}
            {{- else }}
            # Real GCP validation specific environment variables
            - name: GCP_VALIDATOR_IMAGE
              value: {{ .Values.validation.real.gcpValidatorImage | quote }}
            - name: DISABLED_VALIDATORS
              value: {{ .Values.validation.real.disabledValidators | quote }}
            - name: REQUIRED_APIS
              value: {{ .Values.validation.real.requiredApis | quote }}
            - name: VALIDATOR_LOG_LEVEL
              value: {{ .Values.validation.real.logLevel | default "info" | quote }}
            {{- end }}
          resources:
            limits:
              cpu: 500m
              memory: 512Mi
            requests:
              cpu: 100m
              memory: 128Mi
          volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: adapter-config
              mountPath: /etc/adapter
              readOnly: true
            {{- if .Values.broker.type }}
            - name: broker-config
              mountPath: /etc/broker/broker.yaml
              subPath: broker.yaml
              readOnly: true
            {{- end }}
      volumes:
        - name: tmp
          emptyDir: {}
        - name: adapter-config
          configMap:
            name: {{ include "validation-gcp.configMapName" . }}
        {{- if .Values.broker.type }}
        - name: broker-config
          configMap:
            name: {{ include "validation-gcp.brokerConfigMapName" . }}
            items:
              - key: broker.yaml
                path: broker.yaml
        {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
